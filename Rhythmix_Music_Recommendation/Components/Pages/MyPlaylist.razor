@page "/my-playlists"
@using Rhythmix_Music_Recommendation.Services
@using Rhythmix_Music_Recommendation.Components.Domain
@rendermode InteractiveServer
@inject MusicDataService DataService
@inject NavigationManager NavigationManager

<PageTitle>My Playlists</PageTitle>

<div style="margin-top: 10px; padding: 40px;">
    <h1 style="border-bottom: 2px solid #8A2BE2; padding-bottom: 10px;">My Playlists</h1>

    @* Now that the service is Scoped, this count only reflects the CURRENT user/guest *@
    @if (DataService.Playlists == null || !DataService.Playlists.Any())
    {
        <div style="margin-top: 50px; text-align: center; color: #555;">
            <i class="fa fa-music" style="font-size: 100px; color: #ddd;"></i>
            <p style="font-size: 1.5rem; margin-top: 20px;">Your private collection is empty.</p>
            <p>Go to the Home page to create your first playlist!</p>
        </div>
    }
    else
    {
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
            @foreach (var playlist in DataService.Playlists)
            {
                <div style="background: #181818; color: white; padding: 20px; border-radius: 8px; position: relative;">
                    <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 10;">
                        @* Edit Button *@
                        <button @onclick="() => PrepareEdit(playlist)"
                                style="background: #8A2BE2; border: none; color: white; border-radius: 4px; padding: 5px; cursor: pointer;"
                                title="Edit Playlist">
                            <i class="fa fa-pencil"></i>
                        </button>

                        @* Delete Button *@
                        <button @onclick="() => ShowDeleteConfirm(playlist.PlaylistId)"
                                style="background: #dc3545; border: none; color: white; border-radius: 4px; padding: 5px; cursor: pointer;"
                                title="Delete Playlist">
                            <i class="fa fa-trash"></i>
                        </button>

                    </div>
                    <div @onclick="() => GoToPlaylist(playlist)" style="cursor: pointer;">
                        <div style="width: 100%; aspect-ratio: 1/1; background: #282828; display: flex; justify-content: center; align-items: center; margin-bottom: 15px;">
                            @if (!string.IsNullOrEmpty(playlist.CoverImageUrl))
                            {
                                <img src="@playlist.CoverImageUrl" class="cover-image" alt="Playlist cover image" />
                            }
                            else
                            {
                                <i class="fa fa-music" style="font-size: 50px; color: #777;"></i>
                            }
                        </div>
                        <h4>@playlist.Title</h4>
                        <p style="color: #b3b3b3; font-size: 0.8rem; height: 3em; overflow: hidden; text-overflow: ellipsis;">@playlist.Description</p>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* --- EDIT MODAL --- *@
@if (isEditing)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 12px; width: 600px; color: black; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
            <h3 style="margin-top: 0; color: #8A2BE2;">Edit Playlist</h3>
            <header class="format">
                <div class="left-div">
                    <div style="margin-top: 10px; min-height: 40px; display: flex; justify-content: center; align-items: center;">
                        @if (!string.IsNullOrEmpty(editingPlaylist.CoverImageUrl))
                        {
                            <img src="@editingPlaylist.CoverImageUrl" class="cover-image" />
                        }
                        else
                        {

                            <img src="/images/Placeholder_Image.jpg" class="cover-image" />
                        }
                    </div>

                    <div style=" justify-content: center">
                        @if (!string.IsNullOrEmpty(editingPlaylist.CoverImageUrl))
                        {
                            <button class="custom-file-btn" @onclick="ClearCoverImage">Clear Image</button>
                        }
                        else
                        {
                            <label for="fileUpload" class="custom-file-btn">Upload Image</label>
                            <InputFile id="fileUpload" OnChange="HandleImageUpload" accept="image/*" style="display:none;" />

                            @if (!string.IsNullOrEmpty(uploadError))
                            {
                                <div>@uploadError</div>
                            }
                        }
                    </div>

                </div>
                <div class="right-div">

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Name</label>
                        <input @bind="editingPlaylist.Title" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Description</label>
                        <textarea @bind="editingPlaylist.Description" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none;"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button @onclick="() => isEditing = false" style="background: #ccc; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">Cancel</button>
                        <button @onclick="SaveChanges" style="background: #8A2BE2; color: white; border: none; font-size: 0.85rem; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Save Changes</button>
                    </div>
                </div>
            </header>


        </div>
    </div>
}

@if (showDeleteConfirm)
{
    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999;">
        <div style="background: #fff; color: #222; padding: 32px; border-radius: 12px; min-width: 320px; box-shadow: 0 4px 24px rgba(0,0,0,0.18);">
            <h3>Delete Playlist?</h3>
            <p>Are you sure you want to delete this playlist? This action cannot be undone.</p>
            <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 24px;">
                <button @onclick="ConfirmDelete" style="background: #dc3545; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: bold;">Delete</button>
                <button @onclick="() => showDeleteConfirm = false" style="background: #ccc; color: #222; border: none; padding: 10px 24px; border-radius: 6px;">Cancel</button>
            </div>
        </div>
    </div>
}


@code {
    private bool isEditing = false;
    private Playlist editingPlaylist = new();

    private string uploadError = "";
    private IBrowserFile? uploadedImage;

    private bool showDeleteConfirm = false;
    private Guid playlistToDelete;


    private void GoToPlaylist(Playlist playlist)
    {
        NavigationManager.NavigateTo($"/playlist/{playlist.PlaylistId}");
    }


    private void PrepareEdit(Playlist p)
    {
        // We create a "Clone" so changes don't show on the main page until we hit Save
        editingPlaylist = new Playlist
            {
                PlaylistId = p.PlaylistId,
                Title = p.Title,
                Description = p.Description,
                CoverImageUrl = p.CoverImageUrl
            };
        isEditing = true;
    }

    private void SaveChanges()
    {
        DataService.UpdatePlaylist(editingPlaylist);
        isEditing = false;
        // This tells Blazor to re-draw the UI with the updated data
        StateHasChanged();
    }

    private void HandleDelete(Guid id)
    {
        DataService.DeletePlaylist(id);
        StateHasChanged();
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        uploadError = "";
        uploadedImage = e.File;

        try
        {
            // Limit size (e.g., 2 MB)
            const long maxSize = 2 * 1024 * 1024;
            if (uploadedImage.Size > maxSize)
            {
                uploadError = "Image too large (max 2 MB).";
                return;
            }

            // Build path
            var ext = Path.GetExtension(uploadedImage.Name);
            var fileName = $"{Guid.NewGuid()}{ext}";
            var relative = Path.Combine("uploads", "playlist", fileName);            // web path: /uploads/playlists/{file}
            var physical = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "playlist");

            Directory.CreateDirectory(physical);
            var physicalFile = Path.Combine(physical, fileName);

            using var stream = File.Create(physicalFile);
            await uploadedImage.OpenReadStream(maxSize).CopyToAsync(stream);

            editingPlaylist.CoverImageUrl = "/" + relative.Replace("\\", "/"); // normalize for web
        }
        catch (Exception ex)
        {
            uploadError = $"Upload failed: {ex.Message}";
        }
    }

    private void ClearCoverImage()
    {
        editingPlaylist.CoverImageUrl = null;
        uploadedImage = null;
        uploadError = "";
        StateHasChanged();
    }

    private void ShowDeleteConfirm(Guid id)
    {
        playlistToDelete = id;
        showDeleteConfirm = true;
    }

    private void ConfirmDelete()
    {
        HandleDelete(playlistToDelete);
        showDeleteConfirm = false;
    }

}
