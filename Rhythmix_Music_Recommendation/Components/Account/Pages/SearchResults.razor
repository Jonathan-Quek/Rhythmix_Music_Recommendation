@page "/results"

@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using Rhythmix_Music_Recommendation.Components.Domain
@using Rhythmix_Music_Recommendation.Data
@using static Rhythmix_Music_Recommendation.Components.Pages.Home
@using Rhythmix_Music_Recommendation.Services
@using System.Diagnostics

@rendermode InteractiveServer

@inject NavigationManager NavigationManager
@inject IHttpClientFactory HttpClientFactory
@inject Rhythmix_Music_RecommendationContext DbContext
@inject AuthenticationStateProvider AuthProvider
@inject MusicDataService DataService


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">



<h2>Search Results</h2>


<div @onclick="CloseSongMenu">

    <div>

        <input class="form-control"
        placeholder="Search by title, artist, genre, album, or year"
        @bind="searchInput"
        @bind:event="oninput" />

        <button class="btn btn-primary mt-2" @onclick="OnSearch" style="border-radius: 16px;">
            Search
        </button>


    </div>



    <div class="search-filters mt-2">
        <button class="filter-btn @(selectedMode == SearchMode.Songs ? "active" : "")"
        @onclick="() => selectedMode = SearchMode.Songs">
            Song
        </button>

        <button class="filter-btn @(selectedMode == SearchMode.Albums ? "active" : "")"
        @onclick="() => selectedMode = SearchMode.Albums">
            Albums
        </button>

        <button class="filter-btn @(selectedMode == SearchMode.Artists ? "active" : "")"
        @onclick="() => selectedMode = SearchMode.Artists">
            Artists
        </button>
    </div>


    @if (showAddToPlaylistModal && selectedSong != null)
    {
        <div class="rm-overlay" @onclick="CloseAddToPlaylistModal">
            <div class="rm-modal" @onclick:stopPropagation="true">
                <div class="rm-header">
                    <h3 style="margin:0;">Add to Playlist</h3>
                    <button class="rm-close" @onclick="CloseAddToPlaylistModal">&times;</button>
                </div>

                <div class="rm-body">

                    <!-- Song preview (make it look nice like your theme) -->
                    <div style="display:flex; gap:12px; align-items:center;">
                        <img src="@selectedSong.CoverImageUrl"
                        onerror="this.onerror=null;this.src='/images/Placeholder_Image.jpg';"
                        style="width:48px;height:48px;border-radius:6px;object-fit:cover;" />

                        <div style="min-width:0;">
                            <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                @selectedSong.Title
                            </div>
                            <div style="color:#aaa;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                @selectedSong.Artist
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: rgba(255,255,255,0.12);" />

                    <!-- Playlist list -->
                    <div style="display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto;">
                        @if (userPlaylists == null || userPlaylists.Count == 0)
                        {
                            <div style="color:#aaa;">You don’t have any playlists yet.</div>
                        }
                        else
                        {
                            @foreach (var playlist in userPlaylists)
                            {
                                <button type="button"
                                @onclick="() => AddSongToPlaylist(playlist.PlaylistId)"
                                style="
                                        background:#3e3e3e;
                                        border:none;
                                        color:white;
                                        padding:12px;
                                        border-radius:8px;
                                        text-align:left;
                                        cursor:pointer;">
                                    @playlist.Title
                                </button>
                            }
                        }
                    </div>

                    <!-- Create new playlist -->
                    <button type="button"
                    @onclick="OpenCreatePlaylistModal"
                    style="
                            background:transparent;
                            border:1px solid rgba(255,255,255,0.18);
                            color:white;
                            padding:12px;
                            border-radius:8px;
                            text-align:left;
                            cursor:pointer;">
                        + Create new playlist
                    </button>

                </div>
            </div>
        </div>
    }


    @if (showCreatePlaylistModal)
    {
        <div class="rm-overlay" @onclick="CloseCreatePlaylistModal">
            <div class="rm-modal" style="width:500px;" @onclick:stopPropagation="true">

                <div class="rm-header">
                    <h3>Create Playlist</h3>
                    <div>@saveMessage</div>
                    <button class="rm-close" @onclick="CloseCreatePlaylistModal">&times;</button>
                </div>

                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1; text-align: center;">
                        <div style="width: 180px; height: 180px; background: #333; display: flex; justify-content: center; align-items: center;">

                            @if (!string.IsNullOrEmpty(P_coverImageUrl))
                            {
                                <img src="@P_coverImageUrl" class="cover-image" />
                            }
                            else
                            {
                                <i class="fa fa-music" style="font-size: 50px; color: #777;"></i>

                            }

                        </div>
                        <div>

                            @if (!string.IsNullOrEmpty(P_coverImageUrl))
                            {
                                <button class="custom-file-btn" @onclick="ClearCoverImage">Clear Image</button>
                            }
                            else
                            {
                                <label for="fileUpload" class="custom-file-btn">Upload Image</label>
                                <InputFile id="fileUpload" OnChange="e => HandleImageUpload(e, 1)" accept="image/*" style="display:none;" />


                                @if (!string.IsNullOrEmpty(uploadError))
                                {
                                    <div>@uploadError</div>
                                }
                            }

                        </div>

                    </div>
                    <div style="flex: 1.5; display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" @bind="playlistName" placeholder="Playlist Name" style="background: #3e3e3e; border: none; color: white; padding: 12px; border-radius: 4px;" />
                        <textarea @bind="playlistDesc" placeholder="Description" style="background: #3e3e3e; border: none; color: white; padding: 12px; border-radius: 4px; height: 100px; resize: none;"></textarea>
                    </div>
                </div>
                <div class="rm-footer">
                    <button class="rm-primary-btn" @onclick="SavePlaylist">Save</button>
                </div>

            </div>
        </div>
    }



    @if (selectedMode == SearchMode.Songs && songResults.Any())
    {
        <div class="song-list">
            @foreach (var song in songResults)
            {
                <div class="song-row" title="@($"{song.Title} – {song.Artist}")">

                    <img class="song-cover"
                    src="@song.CoverImageUrl"
                    alt="@song.Title"
                    onerror="this.onerror=null;this.src='/images/Placeholder_Image.jpg';" />

                    <div class="song-main">
                        <div class="song-title">@song.Title</div>
                        <div class="song-artist">@song.Artist</div>
                    </div>

                    <div class="song-meta">
                        <span class="song-album">@song.Album.Title</span>
                        <span class="song-genre">@song.Genre</span>
                    </div>

                    <div class="song-year">
                        @* @song.ReleaseYear *@

                        <div class="menu-anchor" @onclick:stopPropagation="true">

                            <button type="button"
                            class="dots-btn"
                            title="More"
                            @onclick:stopPropagation="true"
                            @onclick="() => ToggleSongMenu(song)">
                                ⋮
                            </button>

                            @if (openMenuSongId == song.SongId)
                            {
                                <div class="context-menu context-menu-left"
                                role="menu"
                                @onclick:stopPropagation="true">

                                    <button type="button"
                                    class="menu-item"
                                    role="menuitem"
                                    @onclick="() => MenuAddToPlaylist(song)">
                                        ➕ Add to playlist
                                    </button>

                                    <button type="button"
                                    class="menu-item"
                                    role="menuitem"
                                    @onclick="() => MenuCreatePlaylist(song)">
                                        📁 Create playlist
                                    </button>
                                </div>
                            }

                        </div>

                    </div>

                </div>
            }
        </div>

    }



    else if (selectedMode == SearchMode.Albums && albumResults.Any())
    {
        <div class="album-list">
            @foreach (var album in albumResults)
            {
                <div class="album-row" title="@album.Title">

                    <img class="album-cover"
                    src="@album.CoverImageUrl"
                    alt="@album.Title"
                    onerror="this.onerror=null;this.src='/images/Placeholder_Image.jpg';" />

                    <div class="album-main">
                        <div class="album-title">@album.Title</div>
                        <div class="album-artist">@album.Artist</div>
                    </div>

                    <div class="album-year">
                        @album.ReleaseYear
                    </div>

                </div>
            }
        </div>
    }
    else if (selectedMode == SearchMode.Artists && artistResults.Any())
    {
        <div class="artist-list">
            @foreach (var artist in artistResults)
            {
                <div class="artist-row">

                    <div class="artist-avatar">
                        🎤
                    </div>

                    <div class="artist-main">
                        <div class="artist-name">@artist.Artist</div>
                        <div class="artist-genre">@artist.Genre</div>
                    </div>

                </div>
            }
        </div>
    }
    else
    {
        <p>No results found.</p>
    }

    @if (showToast)
    {
        <div class="rm-toast @toastClass">
            @toastMessage
        </div>
    }


</div>



@code {

    enum SearchMode
    {
        Songs,
        Albums,
        Artists
    }

    private async Task<string> GetSafeCoverSrcAsync(string? url)
    {
        if (string.IsNullOrWhiteSpace(url))
        {
            return "images/Placeholder_Image.jpg"; // Local placeholder image
        }
        try
        {
            var client = HttpClientFactory.CreateClient();
            var response = await client.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                return url;
            }
            else
            {
                return "images/Placeholder_Image.jpg"; // Local placeholder image
            }
        }
        catch
        {
            return "images/Placeholder_Image.jpg"; // Local placeholder image
        }
    }



    private string searchInput = string.Empty;

    private void OnSearch()
    {
        // Update the query parameter in the URL, which will trigger OnParametersSet
        var encoded = Uri.EscapeDataString(searchInput);
        var filter = selectedMode.ToString();
        NavigationManager.NavigateTo($"/results?query={encoded}&mode={filter}");
    }




    [SupplyParameterFromQuery]
    public string? query { get; set; }
    [SupplyParameterFromQuery]
    public string? mode { get; set; }


    private string searchTerm = "";
    private SearchMode selectedMode = SearchMode.Songs;

    // Populating search results
    private List<Song> songResults = new();
    private List<Album> albumResults = new();
    private List<Song> artistResults = new(); //Intended 

    // Boolean logic for pop up pages
    private bool showAddToPlaylistModal = false;
    private bool showCreatePlaylistModal = false;

    private Song? selectedSong;
    private List<Playlist> userPlaylists = new();

    // Create Playlist variables
    private string playlistName = "";
    private string playlistDesc = "";
    private string uploadError = "";
    private string? P_coverImageUrl;
    private IBrowserFile? uploadedImage;
    private string saveMessage = "";

    // Which song's menu is currently open (null = none)
    private int? openMenuSongId = null;

    private bool showToast = false;
    private string toastMessage = "";
    private string toastClass = "toast-success"; // or "toast-error"

    private async void ShowToast(string message, bool success)
    {
        toastMessage = message;
        toastClass = success ? "toast-success" : "toast-error";
        showToast = true;
        StateHasChanged();
        await Task.Delay(2500); // Show for 2.5 seconds
        showToast = false;
        StateHasChanged();
    }



    private void ToggleSongMenu(Song song)
    {
        openMenuSongId = (openMenuSongId == song.SongId) ? null : song.SongId;
    }

    private void CloseSongMenu()
    {
        openMenuSongId = null;
    }

    private async Task MenuAddToPlaylist(Song song)
    {
        CloseSongMenu();
        await OpenAddToPlaylistModal(song);
    }

    private void MenuCreatePlaylist(Song song)
    {
        // Optional: keep selectedSong so after creating you can reopen add-to-playlist if you want
        selectedSong = song;

        CloseSongMenu();
        showAddToPlaylistModal = false;
        showCreatePlaylistModal = true;
    }




    private async Task LoadUserPlaylistsAsync()
    {
        var auth = await AuthProvider.GetAuthenticationStateAsync();
        var userId = auth.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (userId == null) return;

        userPlaylists = await DbContext.Playlists
            .Where(p => p.UserId == userId)
            .OrderBy(p => p.Title)
            .ToListAsync();
    }

    private async Task OpenAddToPlaylistModal(Song song)
    {

        Debug.WriteLine("Dots clicked: " + song?.Title);

        selectedSong = song;
        await LoadUserPlaylistsAsync();
        showAddToPlaylistModal = true;
    }

    private void CloseAddToPlaylistModal() { showAddToPlaylistModal = false; selectedSong = null;}

    private void CloseCreatePlaylistModal() { showCreatePlaylistModal = false;}

    private void OpenCreatePlaylistModal() { showAddToPlaylistModal = false; showCreatePlaylistModal = true;}

    private async Task SavePlaylist()
    {
        if (string.IsNullOrWhiteSpace(playlistName))
        {
            // Optionally, show an error message to the user
            saveMessage = "Playlist name is required.";
            return;
        }



        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userId = authState.User
            .FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)
            ?.Value;

        if (userId == null)
        {
            saveMessage = "User not logged in.";
            return;
        }

        var newP = new Playlist
            {
                PlaylistId = Guid.NewGuid(),
                Title = playlistName,
                Description = playlistDesc,
                CoverImageUrl = P_coverImageUrl,
                UserId = userId
            };

        await DataService.AddPlaylist(newP); // ← make this async if possible

        // If a song is selected, add it to the new playlist
        if (selectedSong != null)
        {
            DbContext.PlaylistSongs.Add(new PlaylistSongs
                {
                    PlaylistId = newP.PlaylistId,
                    SongId = selectedSong.SongId
                });
            await DbContext.SaveChangesAsync();
            ShowToast("Playlist created and song added!", true);
        }

        // Reset fields
        playlistName = "";
        playlistDesc = "";
        P_coverImageUrl = null;
        saveMessage = "";

        showCreatePlaylistModal = false;

        // Refresh playlist list so modal updates instantly
        await LoadUserPlaylistsAsync();

    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e, int i)
    {
        uploadError = "";
        uploadedImage = e.File;
        string target = "";

        if (i == 1)
        {
            target = "playlist";
        }

        if (i == 2)
        {
            target = "album";
        }

        try
        {
            // Limit size (e.g., 2 MB)
            const long maxSize = 2 * 1024 * 1024;
            if (uploadedImage.Size > maxSize)
            {
                uploadError = "Image too large (max 2 MB).";
                return;
            }

            // Build path
            var ext = Path.GetExtension(uploadedImage.Name);
            var fileName = $"{Guid.NewGuid()}{ext}";
            var relative = Path.Combine("uploads", target, fileName);            // web path: /uploads/playlists/{file}
            var physical = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", target);

            Directory.CreateDirectory(physical);
            var physicalFile = Path.Combine(physical, fileName);

            using var stream = File.Create(physicalFile);
            await uploadedImage.OpenReadStream(maxSize).CopyToAsync(stream);

            var url = "/" + relative.Replace("\\", "/"); // normalize for web


            P_coverImageUrl = url;


        }
        catch (Exception ex)
        {
            uploadError = $"Upload failed: {ex.Message}";
        }
    }

    private void ClearCoverImage()
    {
        P_coverImageUrl = null;
        uploadedImage = null;
        uploadError = "";
    }

    private async Task AddSongToPlaylist(Guid playlistId)
    {
        if (selectedSong == null) return;


        bool exists = await DbContext.PlaylistSongs.AnyAsync(ps =>
            ps.PlaylistId == playlistId &&
            ps.SongId == selectedSong.SongId);

        if (exists)
        {
            ShowToast("Song is already in the playlist.", false);
            return; // optionally show message

        }

        DbContext.PlaylistSongs.Add(new PlaylistSongs
            {
                PlaylistId = playlistId,
                SongId = selectedSong.SongId
            });

        await DbContext.SaveChangesAsync();

        Debug.WriteLine($"Added song '{selectedSong.Title}' to playlist {playlistId}");

        ShowToast("Song added to playlist!", true);

        CloseAddToPlaylistModal();
    }


    protected override void OnParametersSet()
    {
        searchInput = query ?? string.Empty;

        if (!string.IsNullOrWhiteSpace(mode) &&
        Enum.TryParse<SearchMode>(mode, out var parsedMode))
        {
            selectedMode = parsedMode;
        }


        if (string.IsNullOrWhiteSpace(query))
        {
            songResults = DbContext.Songs.ToList();
            albumResults = DbContext.Albums.ToList();
            return;
        }

        // Trim whitespace from the query
        var q = query.Trim();

        switch (selectedMode)
        {
            case SearchMode.Songs:
                var preFiltered = DbContext.Songs
                    .Include(s => s.Album)
                    .Where(s =>
                        (s.Title != null && EF.Functions.Like(s.Title, $"%{q}%")) ||
                        (s.Artist != null && EF.Functions.Like(s.Artist, $"%{q}%")) ||
                        (s.Genre != null && EF.Functions.Like(s.Genre, $"%{q}%")) ||
                        (s.Album != null && EF.Functions.Like(s.Album.Title, $"%{q}%")) ||
                        (s.ReleaseYear != null && EF.Functions.Like(s.ReleaseYear.ToString(), $"%{q}%"))
                    )
                    .OrderBy(s => s.Title)
                    .ThenBy(s => s.Artist)
                    .ToList();


                songResults = preFiltered
                    .AsEnumerable()
                    .Where(s =>
                        (s.Title?.Split(' ').Any(w => w.StartsWith(q, StringComparison.OrdinalIgnoreCase)) ?? false) ||
                        (s.Artist?.Split(' ').Any(w => w.StartsWith(q, StringComparison.OrdinalIgnoreCase)) ?? false) ||
                        (s.Genre?.Split(' ').Any(w => w.StartsWith(q, StringComparison.OrdinalIgnoreCase)) ?? false)
                    )
                    .OrderBy(s => s.Title)
                    .ThenBy(s => s.Artist)
                    .ToList();
                break;


            case SearchMode.Albums:
                // Implement album search logic here
                var preFilteredAlbums = DbContext.Albums
                    .Where(a =>
                        (a.Title != null && EF.Functions.Like(a.Title, $"%{q}%")) ||
                        (a.Artist != null && EF.Functions.Like(a.Artist, $"%{q}%"))
                    )
                    .OrderBy(a => a.Title)
                    .ThenBy(a => a.Artist)
                    .ToList();

                albumResults = preFilteredAlbums
                    .AsEnumerable()
                    .Where(a =>
                        (a.Title?.Split(' ').Any(w => w.StartsWith(q, StringComparison.OrdinalIgnoreCase)) ?? false) ||
                        (a.Artist?.Split(' ').Any(w => w.StartsWith(q, StringComparison.OrdinalIgnoreCase)) ?? false)
                    )
                    .OrderBy(a => a.Title)
                    .ThenBy(a => a.Artist)
                    .ToList();
                break;



            case SearchMode.Artists:
                // Implement artist search logic here
                // Get all songs matching the artist or genre
                var preFilteredArtists = DbContext.Songs
                    .Where(s =>
                        (s.Artist != null && EF.Functions.Like(s.Artist, $"%{q}%")) ||
                        (s.Genre != null && EF.Functions.Like(s.Genre, $"%{q}%"))
                    )
                    .OrderBy(s => s.Artist)
                    .ThenBy(s => s.Genre)
                    .ToList();

                // Filter and deduplicate by artist name (case-insensitive)
                artistResults = preFilteredArtists
                    .AsEnumerable()
                    .Where(s =>
                        (s.Artist?.Split(' ').Any(w => w.StartsWith(q, StringComparison.OrdinalIgnoreCase)) ?? false) ||
                        (s.Genre?.Split(' ').Any(w => w.StartsWith(q, StringComparison.OrdinalIgnoreCase)) ?? false)
                    )
                    .GroupBy(s => s.Artist?.Trim().ToLowerInvariant())
                    .Select(g => g.First())
                    .OrderBy(s => s.Artist)
                    .ToList();
                break;

        }
    }

}

